/* ========= CONTROLAUDIT – OWNER-CENTRIC ========= */

/*
Modelo ÚNICO y definitivo:
apps/auditoria/owners/{ownerId}/...
La seguridad se basa EXCLUSIVAMENTE en:
- request.auth.token.appId == 'auditoria'
- request.auth.token.ownerId
*/

// ================================
// EMPRESAS
// ================================
match /apps/auditoria/owners/{ownerId}/empresas/{empresaId} {

  allow read: if isAuth() && request.auth.token.appId == 'auditoria' && (
    ownerId == uid() ||
    (
      request.auth.token.ownerId == ownerId &&
      resource.data.operarios[uid()] == true
    )
  );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid()
    && nonEmptyString("nombre");

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// USUARIOS (admins / operarios)
// ================================
match /apps/auditoria/owners/{ownerId}/usuarios/{userId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      (userId == uid() && request.auth.token.ownerId == ownerId)
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid()
    && request.resource.data.role in ['admin', 'operario'];

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// REPORTES (AUDITORÍAS)
// ================================
match /apps/auditoria/owners/{ownerId}/reportes/{reporteId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId ||
      uid() in resource.data.compartidoCon
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid();

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}
