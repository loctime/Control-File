// ================================
// ControlAudit ‚Äì reglas espec√≠ficas
// ================================

// ========= HELPERS APPID =========
function hasValidAuditAppId() {
  return request.resource.data.appId is string
    && request.resource.data.appId == 'auditoria';
}

function isLegacyAuditDoc() {
  return !('appId' in resource.data);
}

function sameAuditAppId() {
  return resource.data.appId == request.resource.data.appId;
}

// ‚ö†Ô∏è Supermax SOLO para escrituras sensibles
function isAuditSupermax() {
  return isAuth()
    && exists(/databases/$(db)/documents/apps/auditoria/users/$(uid()))
    && get(/databases/$(db)/documents/apps/auditoria/users/$(uid())).data.role == 'supermax';
}

// ================================
// üîê PERFIL USUARIO AUDITORIA
// ================================
match /apps/auditoria/users/{userId} {

  // El usuario solo puede verse a s√≠ mismo
  allow get, update: if isAuth() && uid() == userId;

  // Creaci√≥n controlada (registro inicial o supermax)
  allow create: if isAuth()
    && (uid() == userId || isAuditSupermax())
    && hasValidAuditAppId();
}

// ================================
// üîê LISTADO DE SUBCOLECCIONES
// ================================
match /apps/auditoria/users/{userId}/{collection} {

  // IMPORTANTE:
  // - Solo el due√±o del path puede listar
  // - Evita leaks y errores de permisos
  allow list, read: if isAuth()
    && uid() == userId
    && exists(/databases/$(db)/documents/apps/auditoria/users/$(userId));
}

// ================================
// üîê DOCUMENTOS EN SUBCOLECCIONES
// ================================
match /apps/auditoria/users/{userId}/{collection}/{docId} {

  allow read, create, update, delete: if isAuth()
    && (uid() == userId || isAuditSupermax());
}

// ================================
// üîì DATOS GENERALES DE AUDITORIA
// ================================
match /apps/auditoria/{collection}/{document=**} {

  allow read: if isAuth()
    && collection != 'users';

  allow create: if isAuth()
    && collection != 'users'
    && hasValidAuditAppId();

  allow update: if isAuth()
    && collection != 'users'
    && (
      isLegacyAuditDoc()
      || (hasValidAuditAppId() && sameAuditAppId())
    );

  allow delete: if isAuth()
    && collection != 'users';
}

// ================================
// üìä COLECCIONES RA√çZ (AUDITORIA)
// ================================
match /empresas/{id} {
  allow read, write: if isAuth();
}

match /sucursales/{id} {
  allow read, write: if isAuth();
}

match /auditorias/{id} {
  allow read, write: if isAuth();
}

match /formularios/{id} {
  allow read, write: if isAuth();
}

match /empleados/{id} {
  allow read, write: if isAuth();
}

match /accidentes/{id} {
  allow read, write: if isAuth();
}

match /incidentes/{id} {
  allow read, write: if isAuth();
}

match /capacitaciones/{id} {
  allow read, write: if isAuth();
}

match /reportes/{id} {
  allow read, write: if isAuth();
}
