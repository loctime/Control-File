// ========= PLATFORM RULES =========
// Reglas para la capa platform centralizada
// Integrar en firestore.rules principal

// Helper: verificar si es owner (custom claim o UID específico)
function isPlatformOwner() {
  return isAuth() && (
    request.auth.token.role == 'platform_owner' ||
    request.auth.uid == 'OWNER_UID_HERE'  // Reemplazar con UID real del owner
  );
}

// Helper: verificar si es backend (custom claim)
function isBackend() {
  return isAuth() && request.auth.token.role == 'backend';
}

// platform/accounts
match /platform/accounts/{uid} {
  // Usuario puede leer su propia cuenta
  allow read: if isAuth() && uid == request.auth.uid;
  // Owner y backend pueden leer/escribir
  allow read, write: if isPlatformOwner() || isBackend();
}

// platform/plans
match /platform/plans/{planId} {
  // Lectura pública (catálogo)
  allow read: if true;
  // Solo owner/backend puede escribir
  allow write: if isPlatformOwner() || isBackend();
}

// platform/payments
match /platform/payments/{paymentId} {
  // Usuario puede leer sus propios pagos
  allow read: if isAuth() && resource.data.uid == request.auth.uid;
  // Owner y backend pueden leer/escribir
  allow read, write: if isPlatformOwner() || isBackend();
}

// platform/audit (para Fase 2)
match /platform/audit/{auditId} {
  // Solo owner/backend puede leer/escribir
  allow read, write: if isPlatformOwner() || isBackend();
}
