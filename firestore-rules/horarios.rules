/* ===============================
   HORARIOS – REGLAS CORRECTAS
   =============================== */


match /apps/horarios/publicCompanies/{slug} {
  allow read: if true;
  allow create: if isAuth()
    && request.resource.data.ownerId == request.auth.uid;

  allow update, delete: if false;
}

/* ========= PUBLIC SCHEDULES ========= */
match /apps/horarios/publicSchedules/{companySlug}/weeks/{weekId} {

  allow read: if true;

  allow create, update: if request.auth != null
    && request.resource.data.ownerId == request.auth.uid;

  allow delete: if false;
}


/* ========= ENLACES PUBLICOS (LECTURA PÚBLICA) ========= */
match /apps/horarios/enlaces_publicos/{ownerId} {
  allow read: if true;       // Permite ver cartelera pública sin login
  allow write: if isAuth() 
    && request.auth.uid == ownerId;  // Solo el owner puede escribir
}


/* ========= PRODUCTS ========= */
match /apps/horarios/products/{productId} {
  allow read: if isAuth();
  allow update: if isAuth()
    && request.resource.data.ownerId == resource.data.ownerId;
  allow create, delete: if false;
}


/* ========= STOCK MOVIMIENTOS ========= */
match /apps/horarios/stock_movimientos/{movId} {
  allow read: if isAuth();
  allow create: if isAuth()
    && request.resource.data.userId == uid()
    && request.resource.data.ownerId is string;
  allow update, delete: if false;
}


/* ========= USERS ========= */
match /apps/horarios/users/{userId} {
  allow create: if isAuth() && userId == request.auth.uid;
  allow read, update: if isAuth() && userId == request.auth.uid;
  allow delete: if false;
}

match /apps/horarios/invitaciones/{invitacionId} {

  allow read: if isAuth();

  allow update: if isAuth()
    && (
      // El owner puede editar normalmente
      resource.data.ownerId == uid()
      
      // O el invitado puede marcar como usado
      || (
        request.resource.data.usado == true
        && request.resource.data.usadoPor == uid()
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(["usado", "usadoPor", "usadoEn"])
      )
    );

  allow create: if isAuth();
  allow delete: if false;
}


/* ========= CALENDARIO / HORARIOS ========= */
match /apps/horarios/{collection}/{docId} {
  allow read: if isAuth();

  allow write: if isAuth()
    && request.resource.data.ownerId is string
    && request.resource.data.ownerId == request.auth.uid;
}


/* ========= FALLBACK ========= */
match /apps/horarios/{document=**} {
  allow read: if isAuth();
  allow write: if false;
}
