// ========= CONTROLAUDIT (Higiene y Seguridad) =========

// Usuarios
match /usuarios/{userId} {
  allow read: if isAuth() && request.auth.uid == userId;
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax';
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'max' &&
    get(/databases/$(db)/documents/usuarios/$(userId)).data.clienteAdminId == request.auth.uid;
  allow write: if isAuth() && request.auth.uid == userId;
}

// Empresas
match /empresas/{empresaId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     resource.data.propietarioId == request.auth.uid ||
     get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == resource.data.propietarioId);
  allow write: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     resource.data.propietarioId == request.auth.uid ||
     get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == resource.data.propietarioId);
}

// Sucursales
match /sucursales/{sucursalId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
     (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
      get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId));
  allow write: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
     (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
      get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId));
}

// Auditorías
match /auditorias/{auditoriaId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     resource.data.empresa == request.auth.uid ||
     exists(/databases/$(db)/documents/empresas/$(resource.data.empresa)) &&
     (get(/databases/$(db)/documents/empresas/$(resource.data.empresa)).data.propietarioId == request.auth.uid ||
      get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresa)).data.propietarioId));
  allow write: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     (request.resource.data.empresa != null && 
      exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresa)) &&
      (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresa)).data.propietarioId == request.auth.uid ||
       get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresa)).data.propietarioId)));
}

// Reportes (Auditorías antiguas)
match /reportes/{reporteId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     resource.data.usuarioId == request.auth.uid ||
     request.auth.uid in resource.data.compartidoCon);
  allow write: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     resource.data.usuarioId == request.auth.uid ||
     request.auth.uid in resource.data.compartidoCon);
}

// Formularios
match /formularios/{formularioId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     resource.data.clienteAdminId == request.auth.uid ||
     get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == resource.data.clienteAdminId);
  allow write: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     resource.data.clienteAdminId == request.auth.uid ||
     get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == resource.data.clienteAdminId);
}

// Logs
match /logs/{logId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax';
  allow write: if isAuth();
}

// Empleados
match /empleados/{empleadoId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     (resource.data.empresaId != null && 
      exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
      (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
       get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId)));
  allow write: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     (request.resource.data.empresaId != null && 
      exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)) &&
      (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId == request.auth.uid ||
       get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId)));
}

// Accidentes
match /accidentes/{accidenteId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     (resource.data.empresaId != null && 
      exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
      (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
       get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId)));
  allow write: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     (request.resource.data.empresaId != null && 
      exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)) &&
      (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId == request.auth.uid ||
       get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId)));
}

// Incidentes
match /incidentes/{incidenteId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     (resource.data.empresaId != null && 
      exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
      (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
       get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId)));
  allow write: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     (request.resource.data.empresaId != null && 
      exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)) &&
      (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId == request.auth.uid ||
       get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId)));
}

// Capacitaciones
match /capacitaciones/{capacitacionId} {
  allow read: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     (resource.data.empresaId != null && 
      exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
      (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
       get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId)));
  allow write: if isAuth() && 
    exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
    (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
     (request.resource.data.empresaId != null && 
      exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)) &&
      (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId == request.auth.uid ||
       get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId)));
}

