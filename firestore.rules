rules_version = '2';

service cloud.firestore {
  match /databases/{db}/documents {

    /* ========= BASE ========= */
    
    // ========= HELPERS BASE =========
    function isAuth() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    
    // Roles desde documento - CONTROL-STORE
    function controlStoreUserDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/control-store/users/$(uid()));
    }
    function controlStoreUserRole() {
      return isAuth() && controlStoreUserDocExists()
        ? get(/databases/$(db)/documents/apps/control-store/users/$(uid())).data.role
        : null;
    }
    
    // Roles desde documento - CONTROLREMITO (para otras apps)
    function userDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/controlRemito/users/$(uid()));
    }
    function userRole() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.role
        : null;
    }
    
    function userBranchId() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.branchId
        : null;
    }
    
    // Helpers para CONTROL-STORE
    function isControlStoreMaxDev() { return controlStoreUserRole() == 'maxdev'; }
    function isControlStoreAdmin()  { return controlStoreUserRole() == 'admin' || controlStoreUserRole() == 'maxdev'; }
    
    // Helpers para CONTROLREMITO y otras apps
    function isMaxDev() { return userRole() == 'maxdev'; }
    function isAdmin()  { return userRole() == 'admin' || userRole() == 'maxdev'; }
    function isFactory(){ return userRole() == 'factory'; }
    function isBranch() { return userRole() == 'branch'; }
    function isDelivery(){return userRole() == 'delivery'; }
    
    // Operación y campos
    function isCreate() { return !exists(resource.path); }
    function isUpdate() { return exists(resource.path); }
    
    // Dueño por campo (e.g., userId/ownerId)
    function ownerIs(field) {
      return isAuth() && (
        (isCreate() && request.resource.data[field] == uid()) ||
        (isUpdate() && resource.data[field] == uid() && request.resource.data[field] == uid())
      );
    }
    
    // Inmutabilidad
    function unchanged(field) {
      return isUpdate() ? request.resource.data[field] == resource.data[field] : true;
    }
    
    // Tipos y validadores comunes
    function strBetween(field, min, max) {
      return request.resource.data[field] is string
          && request.resource.data[field].size() >= min
          && request.resource.data[field].size() <= max;
    }
    function nonEmptyString(field) {
      return request.resource.data[field] is string && request.resource.data[field].size() >= 1;
    }
    function isBool(field) { return request.resource.data[field] is bool; }
    function isInt(field) {
      return request.resource.data[field] is number
          && (request.resource.data[field] % 1) == 0;
    }
    function isTs(field) { return request.resource.data[field] is timestamp; }
    function isStringOrNull(field) {
      return !(field in request.resource.data) || request.resource.data[field] is string || request.resource.data[field] == null;
    }
    
    // Lectura pública por flag booleano del doc
    function publicRead(flagField) {
      return resource.data[flagField] == true;
    }
    
    

    /* ========= CONTROLFILE ========= */
    
    // ========= CONTROLFILE =========
    
    // Archivos
    match /files/{fileId} {
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow read, update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Carpetas
    match /folders/{folderId} {
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow read, update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Sesiones de upload
    match /uploadSessions/{sessionId} {
      allow create: if isAuth() && request.resource.data.uid == uid();
      allow read, update, delete: if isAuth() && resource.data.uid == uid();
    }
    
    // Compartir archivos
    match /shares/{shareId} {
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow read: if resource.data.isPublic == true || (isAuth() && resource.data.userId == uid());
      allow update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Papelera
    match /trash/{trashId} {
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow read, update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Usuarios
    match /users/{userId} {
      allow create: if isAuth() && userId == uid();
      allow read, update, delete: if isAuth() && userId == uid();
    }
    
    

    /* ========= CONTROLBIO ========= */
    
    // ========= CONTROLBIO (link-in-bio) =========
    
    match /apps/controlbio/users/{userId} {
      allow read: if true;
    
      allow create: if isAuth()
        && userId == uid()
        && request.resource.data.uid == uid()
        && request.resource.data.email == request.auth.token.email
        && strBetween("username", 3, 20)
        && strBetween("displayName", 1, 50);
    
      allow update: if isAuth()
        && userId == uid()
        && unchanged("uid")
        && unchanged("email")
        && strBetween("username", 3, 20)
        && strBetween("displayName", 1, 50);
    
      allow delete: if isAuth() && userId == uid();
    }
    
    match /apps/controlbio/links/{linkId} {
      allow read: if publicRead("isActive") || (isAuth() && resource.data.userId == uid());
    
      allow create: if ownerIs("userId")
        && strBetween("title", 1, 100)
        && nonEmptyString("url")
        && isInt("order")
        && isBool("isActive")
        && isStringOrNull("sectionId")
        && isTs("createdAt")
        && isTs("updatedAt");
    
      // Actualización: Permite actualizaciones parciales
      allow update: if isAuth()
        && resource.data.userId == uid()
        && (!("userId" in request.resource.data) || request.resource.data.userId == resource.data.userId)
        && (!("title" in request.resource.data) || (request.resource.data.title is string && request.resource.data.title.size() >= 1 && request.resource.data.title.size() <= 100))
        && (!("url" in request.resource.data) || (request.resource.data.url is string && request.resource.data.url.size() >= 1))
        && (!("order" in request.resource.data) || (request.resource.data.order is number && (request.resource.data.order % 1) == 0))
        && (!("isActive" in request.resource.data) || request.resource.data.isActive is bool)
        && (!("sectionId" in request.resource.data) || request.resource.data.sectionId is string || request.resource.data.sectionId == null)
        && (!("createdAt" in request.resource.data) || request.resource.data.createdAt == resource.data.createdAt)
        && (!("updatedAt" in request.resource.data) || request.resource.data.updatedAt is timestamp);
    
      allow delete: if ownerIs("userId");
    }
    
    match /apps/controlbio/sections/{sectionId} {
      allow read: if publicRead("isActive") || (isAuth() && resource.data.userId == uid());
    
      allow create: if ownerIs("userId")
        && strBetween("title", 1, 50)
        && isInt("order")
        && isBool("isActive")
        && isTs("createdAt")
        && isTs("updatedAt");
    
      allow update: if ownerIs("userId")
        && unchanged("userId")
        && strBetween("title", 1, 50)
        && isInt("order")
        && isBool("isActive")
        && unchanged("createdAt")
        && isTs("updatedAt");
    
      allow delete: if ownerIs("userId");
    }
    
    match /apps/controlbio/carousels/{carouselId} {
      allow read: if publicRead("isPublic") || (isAuth() && resource.data.userId == uid());
    
      allow create: if ownerIs("userId")
        && strBetween("name", 1, 100)
        && request.resource.data.type in ['horizontal','grid','masonry','card']
        && request.resource.data.imageFileIds is list
        && isInt("order")
        && isBool("isActive")
        && isBool("isPublic")
        && isTs("createdAt")
        && isTs("updatedAt");
    
      allow update: if ownerIs("userId")
        && unchanged("userId")
        && strBetween("name", 1, 100)
        && request.resource.data.type in ['horizontal','grid','masonry','card']
        && request.resource.data.imageFileIds is list
        && isInt("order")
        && isBool("isActive")
        && isBool("isPublic")
        && unchanged("createdAt")
        && isTs("updatedAt");
    
      allow delete: if ownerIs("userId");
    }
    
    // Galerías de controlbio
    match /apps/controlbio/galleries/{galleryId} {
      allow read: if publicRead("isActive") || (isAuth() && resource.data.userId == uid());
    
      allow create: if ownerIs("userId")
        && strBetween("name", 1, 100)
        && request.resource.data.layout in ['grid','masonry','carousel']
        && request.resource.data.imageFileIds is list
        && isInt("order")
        && isBool("isActive")
        && isTs("createdAt")
        && isTs("updatedAt");
    
      allow update: if ownerIs("userId")
        && unchanged("userId")
        && strBetween("name", 1, 100)
        && request.resource.data.layout in ['grid','masonry','carousel']
        && request.resource.data.imageFileIds is list
        && isInt("order")
        && isBool("isActive")
        && unchanged("createdAt")
        && isTs("updatedAt");
    
      allow delete: if ownerIs("userId");
    }
    
    // Layouts de galería de controlbio
    match /apps/controlbio/galleryLayouts/{layoutId} {
      // Permitir lectura si:
      // 1. Es público y existe, O
      // 2. El usuario autenticado es el dueño (layoutId == userId) - cubre documentos existentes y no existentes
      allow read: if 
        (exists(resource.path) && publicRead("isPublic")) ||
        (isAuth() && layoutId == uid());
    
      allow create: if isAuth()
        && layoutId == uid()
        && request.resource.data.userId == uid()
        && request.resource.data.items is list
        && request.resource.data.settings is map
        && isBool("isPublic")
        && (!("id" in request.resource.data) || request.resource.data.id is string)
        && (!("createdAt" in request.resource.data) || request.resource.data.createdAt is string)
        && (!("updatedAt" in request.resource.data) || request.resource.data.updatedAt is string);
    
      allow update: if isAuth()
        && layoutId == uid()
        && exists(resource.path)
        && resource.data.userId == uid()
        && (!("userId" in request.resource.data) || request.resource.data.userId == resource.data.userId)
        && (!("items" in request.resource.data) || request.resource.data.items is list)
        && (!("settings" in request.resource.data) || request.resource.data.settings is map)
        && (!("isPublic" in request.resource.data) || request.resource.data.isPublic is bool)
        && (!("id" in request.resource.data) || request.resource.data.id is string)
        && (!("createdAt" in request.resource.data) || request.resource.data.createdAt is string)
        && (!("updatedAt" in request.resource.data) || request.resource.data.updatedAt is string);
    
      allow delete: if isAuth() 
        && layoutId == uid()
        && exists(resource.path)
        && resource.data.userId == uid();
    }
    
    // Archivos de controlbio (para galerías públicas)
    match /files/{fileId} {
      // Permitir lectura si:
      // 1. El archivo pertenece al usuario autenticado, O
      // 2. El archivo pertenece a un usuario con galería pública Y el archivo no está eliminado Y tiene downloadURL
      allow read: if 
        (isAuth() && resource.data.userId == uid()) ||
        (
          resource.data.userId != null &&
          resource.data.deletedAt == null &&
          "downloadURL" in resource.data &&
          resource.data.downloadURL is string &&
          exists(/databases/$(db)/documents/apps/controlbio/galleryLayouts/$(resource.data.userId)) &&
          get(/databases/$(db)/documents/apps/controlbio/galleryLayouts/$(resource.data.userId)).data.isPublic == true
        );
    
      // Solo el dueño puede crear/actualizar/eliminar
      allow create: if isAuth() 
        && request.resource.data.userId == uid()
        && request.resource.data.deletedAt == null;
    
      allow update: if isAuth() 
        && resource.data.userId == uid()
        && (!("userId" in request.resource.data) || request.resource.data.userId == resource.data.userId);
    
      allow delete: if isAuth() && resource.data.userId == uid();
    }
    
    

    /* ========= CONTROLCICLO ========= */
    
    // ========= CONTROLCICLO =========
    
    match /apps/controlciclo/users/{userId}/{document=**} {
      allow read, write: if isAuth() && userId == uid();
    }
    
    

    /* ========= CONTROLREMITO ========= */
    
    // ========= CONTROLREMITO (remitos) =========
    
    match /apps/controlRemito {
      match /users/{userId} {
        allow read: if isAuth();
        allow create, update: if isAuth();
        allow delete: if isAdmin();
      }
    
      match /branches/{branchId} {
        allow read: if isAuth();
        allow create, update, delete: if isAdmin();
      }
    
      match /products/{productId} {
        allow read: if isAuth();
        allow create: if isAdmin() || isFactory();
        allow update, delete: if isAdmin();
      }
    
      match /orders/{orderId} {
        allow read, create, update: if isAuth();
        allow delete: if isAdmin();
      }
    
      match /deliveryNotes/{noteId} {
        allow read, create, update: if isAuth();
        allow delete: if isAdmin();
      }
    
      match /templates/{templateId} {
        allow read, create, update, delete: if isAuth();
      }
    
      match /remit-metadata/{metadataId} {
        allow read, create, update: if isAuth();
        allow delete: if isAdmin();
      }
    
      match /replacementQueues/{queueId} {
        allow read, create, update: if isAuth();
        allow delete: if isAdmin() || (isAuth() && userBranchId() != null && resource.data.branchId == userBranchId());
      }
    }
    
    // Auditoría global
    match /audit/{auditId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    

    /* ========= CONTROLGASTOS ========= */
    
    // ========= CONTROLGASTOS =========
    
    // Estructura organizada: apps/controlgastos/users/{userId}/...
    match /apps/controlgastos/users/{userId}/expenses/{expenseId} {
      allow read, write: if isAuth() && userId == uid();
      allow create: if isAuth() && userId == uid();
      allow update, delete: if isAuth() && userId == uid();
    }
    
    match /apps/controlgastos/users/{userId}/payments/{paymentId} {
      allow read, write: if isAuth() && userId == uid();
      allow create: if isAuth() && userId == uid();
      allow update, delete: if isAuth() && userId == uid();
    }
    
    match /apps/controlgastos/users/{userId}/receipts/{receiptId} {
      allow read, write: if isAuth() && userId == uid();
      allow create: if isAuth() && userId == uid();
      allow update, delete: if isAuth() && userId == uid();
    }
    
    match /apps/controlgastos/users/{userId}/recurring_items/{itemId} {
      allow read: if isAuth() && userId == uid();
      allow create: if isAuth() 
                    && userId == uid()
                    && request.resource.data.userId == userId;
      allow update: if isAuth() 
                    && userId == uid()
                    && resource.data.userId == userId;
      allow delete: if isAuth() 
                    && userId == uid()
                    && resource.data.userId == userId;
    }
    
    match /apps/controlgastos/users/{userId}/recurring_items_instances/{instanceId} {
      allow read: if isAuth() && userId == uid();
      allow create: if isAuth() 
                    && userId == uid()
                    && request.resource.data.userId == userId;
      allow update: if isAuth() 
                    && userId == uid()
                    && resource.data.userId == userId;
      allow delete: if isAuth() 
                    && userId == uid()
                    && resource.data.userId == userId;
    }
    
    match /apps/controlgastos/users/{userId}/settings/{settingId} {
      allow read, write: if isAuth() && userId == uid();
      allow create: if isAuth() && userId == uid();
      allow update, delete: if isAuth() && userId == uid();
    }
    
    // Colecciones globales de ControlGastos
    match /apps/controlgastos/categories/{categoryId} {
      allow read: if isAuth();
      allow write: if isAuth();
    }
    
    // Reglas legacy para ControlGastos (temporal - compatibilidad hacia atrás)
    match /expenses/{expenseId} {
      allow read, write: if isAuth() && resource.data.userId == uid();
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    match /payments/{paymentId} {
      allow read, write: if isAuth() && resource.data.userId == uid();
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    match /invoices/{invoiceId} {
      allow read, write: if isAuth() && resource.data.userId == uid();
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow update, delete: if isAuth() && resource.data.userId == uid();
    }
    

    /* ========= CONTROLLAUDIT ========= */
    
    // ========= CONTROLAUDIT (Higiene y Seguridad) =========
    
    // Usuarios
    match /usuarios/{userId} {
      allow read: if isAuth() && request.auth.uid == userId;
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax';
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'max' &&
        get(/databases/$(db)/documents/usuarios/$(userId)).data.clienteAdminId == request.auth.uid;
      allow write: if isAuth() && request.auth.uid == userId;
    }
    
    // Empresas
    match /empresas/{empresaId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         resource.data.propietarioId == request.auth.uid ||
         get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == resource.data.propietarioId);
      allow write: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         resource.data.propietarioId == request.auth.uid ||
         get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == resource.data.propietarioId);
    }
    
    // Sucursales
    match /sucursales/{sucursalId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
         (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
          get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId));
      allow write: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
         (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
          get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId));
    }
    
    // Auditorías
    match /auditorias/{auditoriaId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         resource.data.empresa == request.auth.uid ||
         exists(/databases/$(db)/documents/empresas/$(resource.data.empresa)) &&
         (get(/databases/$(db)/documents/empresas/$(resource.data.empresa)).data.propietarioId == request.auth.uid ||
          get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresa)).data.propietarioId));
      allow write: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         (request.resource.data.empresa != null && 
          exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresa)) &&
          (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresa)).data.propietarioId == request.auth.uid ||
           get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresa)).data.propietarioId)));
    }
    
    // Reportes (Auditorías antiguas)
    match /reportes/{reporteId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         resource.data.usuarioId == request.auth.uid ||
         request.auth.uid in resource.data.compartidoCon);
      allow write: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         resource.data.usuarioId == request.auth.uid ||
         request.auth.uid in resource.data.compartidoCon);
    }
    
    // Formularios
    match /formularios/{formularioId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         resource.data.clienteAdminId == request.auth.uid ||
         get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == resource.data.clienteAdminId);
      allow write: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         resource.data.clienteAdminId == request.auth.uid ||
         get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == resource.data.clienteAdminId);
    }
    
    // Logs
    match /logs/{logId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax';
      allow write: if isAuth();
    }
    
    // Empleados
    match /empleados/{empleadoId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         (resource.data.empresaId != null && 
          exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
          (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
           get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId)));
      allow write: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         (request.resource.data.empresaId != null && 
          exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)) &&
          (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId == request.auth.uid ||
           get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId)));
    }
    
    // Accidentes
    match /accidentes/{accidenteId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         (resource.data.empresaId != null && 
          exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
          (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
           get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId)));
      allow write: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         (request.resource.data.empresaId != null && 
          exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)) &&
          (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId == request.auth.uid ||
           get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId)));
    }
    
    // Incidentes
    match /incidentes/{incidenteId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         (resource.data.empresaId != null && 
          exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
          (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
           get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId)));
      allow write: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         (request.resource.data.empresaId != null && 
          exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)) &&
          (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId == request.auth.uid ||
           get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId)));
    }
    
    // Capacitaciones
    match /capacitaciones/{capacitacionId} {
      allow read: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         (resource.data.empresaId != null && 
          exists(/databases/$(db)/documents/empresas/$(resource.data.empresaId)) &&
          (get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId == request.auth.uid ||
           get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(resource.data.empresaId)).data.propietarioId)));
      allow write: if isAuth() && 
        exists(/databases/$(db)/documents/usuarios/$(request.auth.uid)) &&
        (get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.role == 'supermax' ||
         (request.resource.data.empresaId != null && 
          exists(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)) &&
          (get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId == request.auth.uid ||
           get(/databases/$(db)/documents/usuarios/$(request.auth.uid)).data.clienteAdminId == get(/databases/$(db)/documents/empresas/$(request.resource.data.empresaId)).data.propietarioId)));
    }
    
    

    /* ========= CONTROLSTORE ========= */
    
    // ========= CONTROL-STORE =========
    
    // Helper para obtener ownerId de una tienda
    function storeOwnerId(storeId) {
      return get(/databases/$(db)/documents/apps/control-store/stores/$(storeId)).data.ownerId;
    }
    
    // Usuario de control-store
    match /apps/control-store/users/{userId} {
      allow create: if isAuth() 
        && userId == uid()
        && request.resource.data.email != null
        && request.resource.data.displayName != null;
    
      allow read: if isAuth() && (userId == uid() || isControlStoreAdmin());
      allow update: if isAuth() && userId == uid();
      allow delete: if isAuth() && userId == uid();
    }
    
    // Tiendas
    match /apps/control-store/stores/{storeId} {
      allow read: if true;
    
      allow create: if isAuth() 
        && request.resource.data.ownerId == uid()
        && request.resource.data.ownerEmail != null
        && request.resource.data.slug != null
        && request.resource.data.name != null;
    
      allow update: if isAuth() && (
        (resource.data.ownerId == uid() && request.resource.data.ownerId == resource.data.ownerId) ||
        (isControlStoreAdmin() || isControlStoreMaxDev()) ||
        (request.resource.data.ownerId == uid() && request.resource.data.ownerEmail != null)
      );
    
      allow delete: if isAuth() && (
        resource.data.ownerId == uid() ||
        (isControlStoreAdmin() || isControlStoreMaxDev())
      );
    
      // Productos de cada tienda
      match /products/{productId} {
        allow read: if true;
        allow create: if isAuth() && storeOwnerId(storeId) == uid();
        allow update, delete: if isAuth() && storeOwnerId(storeId) == uid();
      }
    
      // Categorías de cada tienda
      match /categories/{categoryId} {
        allow read: if true;
        allow create: if isAuth() && storeOwnerId(storeId) == uid();
        allow update, delete: if isAuth() && storeOwnerId(storeId) == uid();
      }
    }
    
    // Invitaciones
    match /apps/control-store/invitations/{invitationId} {
      allow read: if true;
      allow create: if isAuth();
      allow update: if isAuth() && !resource.data.used;
      allow delete: if false;
    }
    
    // Transferencias de tiendas
    match /apps/control-store/transfers/{transferId} {
      allow read: if true;
      allow create: if isAuth() && (isControlStoreAdmin() || isControlStoreMaxDev());
      allow update: if isAuth() && !resource.data.used;
      allow delete: if isAuth() && (isControlStoreAdmin() || isControlStoreMaxDev());
    }
    
    

    /* ========= HORARIOS ========= */
    
    // ========= HORARIOS SCHEDULER =========
    
    // Helpers específicos para HORARIOS
    function horariosUserDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()));
    }
    function horariosUserRole() {
      return isAuth() && horariosUserDocExists()
        ? get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role
        : null;
    }
    function isHorariosMaxDev() { return horariosUserRole() == 'maxdev'; }
    function isHorariosAdmin()  { return horariosUserRole() == 'admin' || horariosUserRole() == 'maxdev'; }
    function isHorariosUser()   { return horariosUserRole() == 'user' || isHorariosAdmin(); }
    
    // Colección: apps/horarios/users
    match /apps/horarios/users/{userId} {
      allow read: if isAuth() && (uid() == userId || isHorariosUser());
      allow create: if isAuth() && uid() == userId
        && nonEmptyString('uid')
        && request.resource.data.uid == uid()
        && isStringOrNull('email')
        && isStringOrNull('displayName')
        && isStringOrNull('photoURL')
        && (isStringOrNull('role') || request.resource.data.role == 'user' || request.resource.data.role == 'admin' || request.resource.data.role == 'maxdev')
        && isTs('createdAt')
        && isTs('updatedAt');
      // Usuario puede actualizar sus propios datos (pero no cambiar su role si ya existe)
      allow update: if isAuth() && uid() == userId
        && unchanged('uid')
        && (unchanged('role') || (!('role' in resource.data) && request.resource.data.role == 'user'))
        && isStringOrNull('email')
        && isStringOrNull('displayName')
        && isStringOrNull('photoURL')
        && unchanged('createdAt')
        && isTs('updatedAt');
      // Admin puede actualizar cualquier usuario (incluyendo roles)
      allow update: if isAuth() && isHorariosAdmin()
        && unchanged('uid')
        && isStringOrNull('email')
        && isStringOrNull('displayName')
        && isStringOrNull('photoURL')
        && (isStringOrNull('role') || request.resource.data.role == 'user' || request.resource.data.role == 'admin' || request.resource.data.role == 'maxdev')
        && unchanged('createdAt')
        && isTs('updatedAt');
      allow delete: if isAuth() && isHorariosAdmin();
    }
    
    // Colección: apps/horarios/employees
    match /apps/horarios/employees/{empleadoId} {
      allow read: if isAuth() && isHorariosUser();
      allow create: if isAuth() && isHorariosUser()
        && nonEmptyString('name')
        && isStringOrNull('email')
        && isStringOrNull('phone')
        && isTs('createdAt')
        && isTs('updatedAt');
      allow update: if isAuth() && isHorariosUser()
        && nonEmptyString('name')
        && isStringOrNull('email')
        && isStringOrNull('phone')
        && unchanged('createdAt')
        && isTs('updatedAt');
      allow delete: if isAuth() && isHorariosAdmin();
    }
    
    // Colección: apps/horarios/shifts
    match /apps/horarios/shifts/{turnoId} {
      allow read: if isAuth() && isHorariosUser();
      allow create: if isAuth() && isHorariosUser()
        && nonEmptyString('name')
        && isStringOrNull('startTime')
        && isStringOrNull('endTime')
        && nonEmptyString('color')
        && isTs('createdAt')
        && isTs('updatedAt');
      allow update: if isAuth() && isHorariosUser()
        && nonEmptyString('name')
        && isStringOrNull('startTime')
        && isStringOrNull('endTime')
        && nonEmptyString('color')
        && unchanged('createdAt')
        && isTs('updatedAt');
      allow delete: if isAuth() && isHorariosAdmin();
    }
    
    // Colección: apps/horarios/schedules
    match /apps/horarios/schedules/{horarioId} {
      allow read: if isAuth() && isHorariosUser();
      allow create: if isAuth() && isHorariosUser()
        && nonEmptyString('nombre')
        && nonEmptyString('weekStart')
        && nonEmptyString('semanaInicio')
        && nonEmptyString('semanaFin')
        && request.resource.data.assignments is map
        && isTs('createdAt')
        && isTs('updatedAt')
        && (isStringOrNull('createdBy') || request.resource.data.createdBy == uid())
        && isStringOrNull('createdByName')
        && isStringOrNull('modifiedBy')
        && isStringOrNull('modifiedByName');
      allow update: if isAuth() && isHorariosUser()
        && nonEmptyString('nombre')
        && nonEmptyString('weekStart')
        && nonEmptyString('semanaInicio')
        && nonEmptyString('semanaFin')
        && request.resource.data.assignments is map
        && unchanged('createdAt')
        && unchanged('createdBy')
        && unchanged('createdByName')
        && isTs('updatedAt')
        && (isStringOrNull('modifiedBy') || request.resource.data.modifiedBy == uid())
        && isStringOrNull('modifiedByName');
      allow delete: if isAuth() && isHorariosAdmin();
    }
    
    // Colección: apps/horarios/historial
    match /apps/horarios/historial/{historialId} {
      allow read: if isAuth() && isHorariosUser();
      allow create: if isAuth() && isHorariosUser()
        && nonEmptyString('horarioId')
        && nonEmptyString('nombre')
        && nonEmptyString('semanaInicio')
        && nonEmptyString('semanaFin')
        && request.resource.data.assignments is map
        && (request.resource.data.accion == 'creado' || request.resource.data.accion == 'modificado')
        && isTs('createdAt')
        && (isStringOrNull('createdBy') || request.resource.data.createdBy == uid())
        && isStringOrNull('createdByName')
        && (isBool('versionAnterior') || !('versionAnterior' in request.resource.data));
      allow update: if false; // Historial es inmutable
      allow delete: if isAuth() && isHorariosAdmin();
    }
    
    

    /* ========= DENY POR DEFECTO ========= */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
