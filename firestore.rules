rules_version = '2';

service cloud.firestore {
  match /databases/{db}/documents {

    /* ========= BASE ========= */

    // ========= HELPERS BASE =========
    function isAuth() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    
    // Roles desde documento - CONTROL-STORE
    function controlStoreUserDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/control-store/users/$(uid()));
    }
    function controlStoreUserRole() {
      return isAuth() && controlStoreUserDocExists()
        ? get(/databases/$(db)/documents/apps/control-store/users/$(uid())).data.role
        : null;
    }
    
    // Roles desde documento - CONTROLREMITO (para otras apps)
    function userDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/controlRemito/users/$(uid()));
    }
    function userRole() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.role
        : null;
    }
    
    function userBranchId() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.branchId
        : null;
    }
    
    // Helpers para CONTROL-STORE
    function isControlStoreMaxDev() { return controlStoreUserRole() == 'maxdev'; }
    function isControlStoreAdmin()  { return controlStoreUserRole() == 'admin' || controlStoreUserRole() == 'maxdev'; }
    
    // Helpers para CONTROLREMITO y otras apps
    function isMaxDev() { return userRole() == 'maxdev'; }
    function isAdmin()  { return userRole() == 'admin' || userRole() == 'maxdev'; }
    function isFactory(){ return userRole() == 'factory'; }
    function isBranch() { return userRole() == 'branch'; }
    function isDelivery(){return userRole() == 'delivery'; }
    function isInvited() { return userRole() == 'invited'; }
    function isManager() { return userRole() == 'manager'; }
    
    // Operaci√≥n y campos
    function isCreate() { return !exists(resource.path); }
    function isUpdate() { return exists(resource.path); }
    
    // Due√±o por campo (e.g., userId/ownerId)
    function ownerIs(field) {
      return isAuth() && (
        (isCreate() && request.resource.data[field] == uid()) ||
        (isUpdate() && resource.data[field] == uid() && request.resource.data[field] == uid())
      );
    }
    
        // Inmutabilidad
        function unchanged(field) {
          return isUpdate() 
            ? (!(field in request.resource.data) || request.resource.data[field] == resource.data[field])
            : true;
        }
    
    // Inmutabilidad flexible - permite null/undefined
    function unchangedOrNull(field) {
      return isUpdate() 
        ? (
            // Si el campo existe en ambos, deben ser iguales
            (field in resource.data && field in request.resource.data && request.resource.data[field] == resource.data[field])
            // O si no existe en ninguno
            || (!(field in resource.data) && !(field in request.resource.data))
            // O si ambos son null
            || (resource.data[field] == null && request.resource.data[field] == null)
            // O si no existe en el original y es null en la actualizaci√≥n
            || (!(field in resource.data) && request.resource.data[field] == null)
            // O si es null en el original y no existe en la actualizaci√≥n
            || (resource.data[field] == null && !(field in request.resource.data))
          )
        : true;
    }
    
    // Tipos y validadores comunes
    function strBetween(field, min, max) {
      return request.resource.data[field] is string
          && request.resource.data[field].size() >= min
          && request.resource.data[field].size() <= max;
    }
    function nonEmptyString(field) {
      return request.resource.data[field] is string && request.resource.data[field].size() >= 1;
    }
    function isBool(field) { return request.resource.data[field] is bool; }
    function isInt(field) {
      return request.resource.data[field] is number
          && (request.resource.data[field] % 1) == 0;
    }
    function isTs(field) { return request.resource.data[field] is timestamp; }
    function isStringOrNull(field) {
      return !(field in request.resource.data) || request.resource.data[field] is string || request.resource.data[field] == null;
    }
    
    // Lectura p√∫blica por flag booleano del doc
    function publicRead(flagField) {
      return resource.data[flagField] == true;
    }
    
    

    /* ========= CONTROLFILE ========= */

    // ========= CONTROLFILE =========
    
    // Archivos
    match /files/{fileId} {
      // READ p√∫blico necesario para shares p√∫blicos v√≠a Cloudflare Worker
      // El control de acceso real est√° en shares/{token} que valida expiraci√≥n y estado
      // Los datos sensibles est√°n en B2, no en Firestore
      allow read: if true;
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Carpetas
    match /folders/{folderId} {
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow read, update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Sesiones de upload
    match /uploadSessions/{sessionId} {
      allow create: if isAuth() && request.resource.data.uid == uid();
      allow read, update, delete: if isAuth() && resource.data.uid == uid();
    }
    
    // ========= SHARES (GLOBAL) =========
    match /shares/{shareId} {
      allow read, write: if true;
    }
    
    // Papelera
    match /trash/{trashId} {
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow read, update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Usuarios
    match /users/{userId} {
      allow create: if isAuth() && userId == uid();
      allow read, update, delete: if isAuth() && userId == uid();
    }
    
    

    /* ========= CONTROLGASTOS ========= */

    // ========= CONTROLGASTOS =========
    
    // Estructura organizada: apps/controlgastos/users/{userId}/...
    match /apps/controlgastos/users/{userId}/expenses/{expenseId} {
      allow read, write: if isAuth() && userId == uid();
      allow create: if isAuth() && userId == uid();
      allow update, delete: if isAuth() && userId == uid();
    }
    
    match /apps/controlgastos/users/{userId}/payments/{paymentId} {
      allow read, write: if isAuth() && userId == uid();
      allow create: if isAuth() && userId == uid();
      allow update, delete: if isAuth() && userId == uid();
    }
    
    match /apps/controlgastos/users/{userId}/receipts/{receiptId} {
      allow read, write: if isAuth() && userId == uid();
      allow create: if isAuth() && userId == uid();
      allow update, delete: if isAuth() && userId == uid();
    }
    
    match /apps/controlgastos/users/{userId}/recurring_items/{itemId} {
      allow read: if isAuth() && userId == uid();
      allow create: if isAuth() 
                    && userId == uid()
                    && request.resource.data.userId == userId;
      allow update: if isAuth() 
                    && userId == uid()
                    && resource.data.userId == userId;
      allow delete: if isAuth() 
                    && userId == uid()
                    && resource.data.userId == userId;
    }
    
    match /apps/controlgastos/users/{userId}/recurring_items_instances/{instanceId} {
      allow read: if isAuth() && userId == uid();
      allow create: if isAuth() 
                    && userId == uid()
                    && request.resource.data.userId == userId;
      allow update: if isAuth() 
                    && userId == uid()
                    && resource.data.userId == userId;
      allow delete: if isAuth() 
                    && userId == uid()
                    && resource.data.userId == userId;
    }
    
    match /apps/controlgastos/users/{userId}/settings/{settingId} {
      allow read, write: if isAuth() && userId == uid();
      allow create: if isAuth() && userId == uid();
      allow update, delete: if isAuth() && userId == uid();
    }
    
    // Colecciones globales de ControlGastos
    match /apps/controlgastos/categories/{categoryId} {
      allow read: if isAuth();
      allow write: if isAuth();
    }
    
    // Reglas legacy para ControlGastos (temporal - compatibilidad hacia atr√°s)
    match /expenses/{expenseId} {
      allow read, write: if isAuth() && resource.data.userId == uid();
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    match /payments/{paymentId} {
      allow read, write: if isAuth() && resource.data.userId == uid();
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow update, delete: if isAuth() && resource.data.userId == uid();
    }
    
    match /invoices/{invoiceId} {
      allow read, write: if isAuth() && resource.data.userId == uid();
      allow create: if isAuth() && request.resource.data.userId == uid();
      allow update, delete: if isAuth() && resource.data.userId == uid();
    }
    

    /* ========= AUDIT ========= */

    match /apps/auditoria/owners/{ownerId}/{document=**} {
    
      allow read, write: if isAuth()
        && (
          uid() == ownerId ||
          request.auth.token.ownerId == ownerId
        );
    }
    
    match /apps/auditoria/owners/{ownerId}/empleados/{empleadoId} {
    
      // LECTURA
      allow read: if isAuth()
        && (
          uid() == ownerId ||
          request.auth.token.ownerId == ownerId
        );
    
      // CREAR
      allow create: if isAuth()
        && (
          // Owner puede crear siempre
          uid() == ownerId ||
    
          // Operario puede crear SOLO si la empresa est√° asignada
          (
            request.auth.token.ownerId == ownerId
            && request.resource.data.empresaId is string
            && request.resource.data.empresaId
               in get(
                 /databases/$(db)/documents/apps/auditoria/owners/$(ownerId)/usuarios/$(uid())
               ).data.empresasAsignadas
          )
        );
    
      // UPDATE / DELETE (permitido por ahora)
      allow update, delete: if isAuth()
        && (
          uid() == ownerId ||
          (
            request.auth.token.ownerId == ownerId
            && resource.data.empresaId is string
            && resource.data.empresaId
               in get(
                 /databases/$(db)/documents/apps/auditoria/owners/$(ownerId)/usuarios/$(uid())
               ).data.empresasAsignadas
          )
        );
    }
    

    /* ========= REPO ========= */

    // ========= CONTROLREPO RULES =========
    
    // Documento principal del usuario en ControlRepo
    match /apps/controlrepo/users/{userId} {
    
      // El usuario autenticado solo puede acceder a su propio documento
      allow read, write: if isAuth() && uid() == userId;
    
      // Subcolecciones del usuario (preferences, futuras)
      // NOTA: githubIntegration ya no se utiliza (GitHub OAuth eliminado)
      match /{subPath=**} {
        allow read, write: if isAuth() && uid() == userId;
      }
    }
    

    /* ========= EMAILS ========= */

    match /apps/emails/{document=**} {
      allow read: if true;
    }
    

    /* ========= VALENTIN ========= */

    /* ========= VALENTIN ========= */
    
    match /apps/valentin/respuestas/{docId} {
      allow read, write: if true;
    }

    /* ========= HORARIOS ========= */

    /* ===============================
       HORARIOS ‚Äì LECTURA P√öBLICA
       =============================== */
    
    /* ========= HELPERS ========= */
    
    function horariosUserOwnerId() {
      return isAuth()
        && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
        ? get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId
        : null;
    }
    
    function horariosCanActFor(ownerId) {
      return isAuth()
        && ownerId != null
        && (
          uid() == ownerId
          || (
            exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
            &&
            get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == ownerId
          )
          || (
            exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
            &&
            get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role
              in ['admin','manager','factory','maxdev']
          )
        );
    }
    
    
    
    /* ===============================
       PUBLIC COMPANIES
       =============================== */
    
    match /apps/horarios/publicCompanies/{slug} {
      allow read: if true;
    
      allow create: if isAuth()
        && request.resource.data.ownerId == uid();
    
      allow update, delete: if false;
    }
    
    /* ===============================
       PUBLIC SCHEDULES
       =============================== */
    
    match /apps/horarios/publicSchedules/{companySlug}/weeks/{weekId} {
      allow read: if true;
    
      allow create, update: if isAuth()
        && request.resource.data.ownerId == uid();
    
      allow delete: if false;
    }
    
    /* ===============================
       PUBLIC OWNERS
       =============================== */
    
    match /apps/horarios/publicOwners/{ownerId} {
      allow read: if true;
      allow write: if horariosCanActFor(ownerId);
    }
    
    /* ===============================
       PRODUCTS
       =============================== */
    
    match /apps/horarios/products/{docId} {
      allow read: if true;
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
      allow update: if horariosCanActFor(
        resource.data.ownerId != null
          ? resource.data.ownerId
          : request.resource.data.ownerId
      );
      allow delete: if horariosCanActFor(resource.data.ownerId);
    }
    
    /* ===============================
       PEDIDOS
       =============================== */
    
    match /apps/horarios/pedidos/{docId} {
      allow read: if true;
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
      allow update: if horariosCanActFor(
        resource.data.ownerId != null
          ? resource.data.ownerId
          : request.resource.data.ownerId
      );
      allow delete: if horariosCanActFor(resource.data.ownerId);
    }
    
    match /apps/horarios/pedidos/{docId}/{sub=**} {
      allow read: if true;
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
      allow update: if horariosCanActFor(
        resource.data.ownerId != null
          ? resource.data.ownerId
          : request.resource.data.ownerId
      );
      allow delete: if horariosCanActFor(resource.data.ownerId);
    }
    
    /* ===============================
       STOCK ACTUAL
       =============================== */
    
    match /apps/horarios/stock_actual/{docId} {
      allow read: if true;
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
      allow update: if horariosCanActFor(
        resource.data.ownerId != null
          ? resource.data.ownerId
          : request.resource.data.ownerId
      );
      allow delete: if horariosCanActFor(resource.data.ownerId);
    }
    
    /* ===============================
       STOCK MOVIMIENTOS
       =============================== */
    
    match /apps/horarios/stock_movimientos/{docId} {
      allow read: if true;
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
      allow update: if horariosCanActFor(
        resource.data.ownerId != null
          ? resource.data.ownerId
          : request.resource.data.ownerId
      );
      allow delete: if horariosCanActFor(resource.data.ownerId);
    }
    
    /* ===============================
       USERS
       =============================== */
    
    match /apps/horarios/users/{userId} {
      allow read: if isAuth()
        && (
          userId == uid()
          || (
            exists(/databases/$(db)/documents/apps/horarios/users/$(userId))
            && horariosCanActFor(
              get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.ownerId
            )
          )
        );
    
      allow create: if isAuth() && userId == uid();
    
      allow update: if isAuth()
        && (
          userId == uid()
          || (
            resource.data.ownerId != null
            && horariosCanActFor(resource.data.ownerId)
          )
        );
    
      allow delete: if isAuth()
        && (
          userId == uid()
          || resource.data.ownerId == uid()
          || (
            resource.data.ownerId != null
            && horariosCanActFor(resource.data.ownerId)
          )
        );
    }
    
    /* ===============================
       INVITACIONES
       =============================== */
    
    match /apps/horarios/invitaciones/{docId} {
      allow read: if true;
    
      allow create: if isAuth();
    
      allow update: if isAuth()
        && (
          resource.data.ownerId == uid()
          ||
          (
            request.resource.data.usado == true
            && request.resource.data.usadoPor == uid()
            && request.resource.data.diff(resource.data).affectedKeys()
              .hasOnly(["usado", "usadoPor", "usadoEn"])
          )
        );
    
      allow delete: if isAuth()
        && resource.data.ownerId != null
        && horariosCanActFor(resource.data.ownerId);
    }
    
    /* ===============================
       EMPLOYEES
       =============================== */
    
    match /apps/horarios/employees/{docId} {
      allow read: if true;
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
    
      allow update, delete: if horariosCanActFor(
        resource.data.ownerId != null
          ? resource.data.ownerId
          : request.resource.data.ownerId
      );
    }
    
    
    /* ===============================
       SHIFTS
       =============================== */
    
    match /apps/horarios/shifts/{docId} {
      allow read: if true;
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
      allow update: if horariosCanActFor(
        resource.data.ownerId != null
          ? resource.data.ownerId
          : request.resource.data.ownerId
      );
      allow delete: if horariosCanActFor(resource.data.ownerId);
    }
    
    /* ===============================
       SCHEDULES
       =============================== */
    
    match /apps/horarios/schedules/{docId} {
    
      allow read: if true;
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
    
      allow update, delete: if isAuth();
    }
    
    /* ===============================
       HISTORIAL (cambios de horarios)
       =============================== */
    
    match /apps/horarios/historial/{historialId} {
      allow read: if isAuth() && resource.data.createdBy == uid();
    
      allow create: if isAuth() && request.resource.data.createdBy == uid();
    
      allow update: if false;
    
      allow delete: if isAuth() && resource.data.createdBy == uid();
    }
    
    /* ===============================
       EMPLOYEE FIXED RULES
       =============================== */
    
    match /apps/horarios/employee_fixed_rules/{ruleId} {
    
      allow read: if isAuth() && (
        resource.data.ownerId == uid()
        ||
        (
          exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
          &&
          get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId
            == resource.data.ownerId
        )
        ||
        (
          exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
          &&
          get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role
            in ['admin', 'manager', 'factory', 'maxdev']
        )
      );
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
    
      allow update, delete: if horariosCanActFor(
        resource.data.ownerId != null
          ? resource.data.ownerId
          : request.resource.data.ownerId
      );
    }
    
    
    /* ===============================
       ENLACES PUBLICOS
       =============================== */
    
    match /apps/horarios/enlaces_publicos/{ownerId} {
      allow read: if true;
    
      allow create, update: if isAuth() && horariosCanActFor(ownerId);
    
      allow delete: if isAuth() && horariosCanActFor(ownerId);
    }
    
    /* ===============================
       CONFIG
       =============================== */
    
    match /apps/horarios/config/{docId} {
      allow read: if true;
    
      allow create: if horariosCanActFor(request.resource.data.ownerId);
    
      allow update, delete: if horariosCanActFor(
        resource.data.ownerId != null
          ? resource.data.ownerId
          : request.resource.data.ownerId
      );
    }
    

    /* ========= MAPPING ========= */

    // =============================================================
    // üö® ARCHIVO PARCIAL DE REGLAS ‚Äì SE CONCATENA AUTOM√ÅTICAMENTE üö®
    //
    // ‚ö†Ô∏è NO ES UN ARCHIVO DE REGLAS COMPLETO
    //
    // PROHIBIDO DEFINIR AQU√ç:
    // ‚ùå rules_version
    // ‚ùå service cloud.firestore
    // ‚ùå match /databases/{database}/documents
    //
    // üëâ Este archivo SOLO puede contener:
    //    match /ruta/{id} { ... }
    //
    // ‚ùó Si agreg√°s un `match /databases/...`
    //    Firestore IGNORA estas reglas sin error visible.
    // =============================================================
    
    
    
      match /apps/mapping/schema/{docId} {
        allow read, write: if true;
      }
    
      match /schemaTemplates/{schemaId} {
        allow read: if true;
        allow write: if true; // Los templates del sistema se guardan autom√°ticamente
      }
    
      match /mappings/{mappingId} {
        allow read, write: if true; // Permitir leer y escribir mapeos
      }
    
    
    

    /* ========= DENY POR DEFECTO ========= */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
